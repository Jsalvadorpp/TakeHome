services:
  db:
    image: postgis/postgis:16-3.4  # Postgres 16 with PostGIS pre-installed
    environment:
      # These three vars initialize the database on first startup.
      # Values are read from your .env file (never hardcoded here).
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
    ports:
      - "5432:5432"  # Expose so DBeaver can still connect via localhost:5432
    volumes:
      - pgdata:/var/lib/postgresql/data  # Persist data between restarts

  api:
    build: .
    ports:
      - "8000:8000"
    volumes:
      - .:/app  # Mount entire project directory
    env_file: .env  # Passes all .env vars to the container (for any app settings)
    environment:
      # Override DATABASE_URL to use "db" â€” Docker's internal hostname for the db service.
      # Outside Docker, the app reads DATABASE_URL=...localhost... from .env directly.
      # In production, set POSTGRES_USER / POSTGRES_PASSWORD / POSTGRES_DB in your
      # secrets manager and this line builds the correct URL automatically.
      - DATABASE_URL=postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@db:5432/${POSTGRES_DB}
    depends_on:
      - db

  daily-ingest:
    build: .
    # Run the daily ingest job in continuous mode (loops every 24 hours).
    # Use --once to run for yesterday and exit instead of looping.
    command: python -m background.daily_ingest_job
    volumes:
      - .:/app  # Mount entire project directory
    env_file: .env
    environment:
      - DATABASE_URL=postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@db:5432/${POSTGRES_DB}
    depends_on:
      - db

volumes:
  pgdata:  # Named volume so database data survives docker-compose down
